(function(){function l(n){$(window).width()<="575"?(r="101vw",e=!0):(r="26em",e=!1);n&&(n.visible||$("div.new-menu").css({left:"-"+r}))}function v(n){for(var i={},r,t=0;t<n.length;t++)r=n[t],i[r]=!0;return Object.keys(i)}function y(n){var t=$("<div />",{html:n});return!!t.find("meta:first-of-type").length}function n(){this.visible=!1;this.mainDiv=$(".today-journal");this.checkUser()}function p(n){var i=[],t;for(n.setDate(n.getDate()-n.getDay()+1),t=0;t<7;t++)i.push(new Date(n)),n.setDate(n.getDate()+1);return i}function t(){var n=this;n.visible=!1}function o(n,t,i,r){var u=this;u.parent=i;u.type=n.EntityType;u.title=n.EntityTitle;u.link=n.Link;u.sub=n.Sub?new f(n.Sub,t,u):undefined;u.handler=r?r:function(){};u.li=u._draw()}function u(n,t,i,r){var u=this;u.main=i;u._place=t;u.name=r?r:"Главное меню";u.list=n.map(function(n){return new o(n,t,u)});u._draw()}function f(n,t,i){var r=this;r.parentListItem=i;r.parentMenuList=r.parentListItem.parent;r.menuList=new u(n,t,!1,r.parentListItem.title);r.menuList.container.prepend(r.makeHeader())}function s(n,t){var i=$("nav > .new-menu > .menu-wrapper").find('a[data-type="'+n+'"] > span.unread');+t?i.length?i.html(t):$("nav > .new-menu > .menu-wrapper").find('a[data-type="'+n+'"]').append($("<span />",{"class":"unread",text:t})):i.remove()}var r,e,h=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),i=document.getElementById("model_menu_user_id").value,c=document.getElementById("model_menu_user_role").value,a=/true/i.test(document.getElementById("model_menu_is_teacher").value);$(document).ready(function(){l();window.mainPageMenu=new t;window.mainPageMenu.load();var i=new n;$(".user-role-item").on("click",function(){var n=$(this).attr("data-roleid");$("#menuRoleId").val(n).trigger("change")});$("#menuRoleId").on("change",function(){$(this).closest("form").submit()});$(".MenuButton").click(function(){i.visible&&$(".today-journal-button").click();$(this).toggleClass("open");$("#menuTitle").toggleClass("open");$("#nav-icon3").toggleClass("open");window.mainPageMenu.toggle()});$(".today-journal-button").click(function(){window.mainPageMenu.visible&&$(".MenuButton").click();$(this).toggleClass("open");i.toggle()});$(document).click(function(n){window.mainPageMenu.visible&&($(n.target).closest(".new-menu").length||$(n.target).closest(".MenuButton").length||$(".MenuButton").click());i.visible&&($(n.target).closest(".today-journal").length||$(n.target).closest(".today-journal-button").length||$(".today-journal-button").click())});$(window).resize(function(){l(window.mainPageMenu)})});n.prototype.toggle=function(){this.visible?this._hide():this._show()};n.prototype._show=function(){var n=this;this.visible=!0;this.mainDiv.addClass("d-flex");setTimeout(function(){n.mainDiv.addClass("open")},4);e&&$("html, body").css({overflow:"hidden"})};n.prototype._hide=function(){var n=this;this.visible=!1;setTimeout(function(){n.mainDiv.removeClass("d-flex")},200);this.mainDiv.removeClass("open");$("html, body").css({overflow:""})};n.prototype.checkUser=function(){a&&($(".today-journal-button").css({display:"flex"}),this.init(),this.load())};n.prototype.load=function(){var n=this,t;try{t=+JSON.parse(window.localStorage.getItem("schedule-lastrefresh"));n._scheduleArray=JSON.parse(window.localStorage.getItem("schedule-array"));n._webinarsArray=JSON.parse(window.localStorage.getItem("webinars-array"))}catch(e){n.update(new Date);return}var u=(new Date).getTime()-t<36e5,i=!!n._scheduleArray,r=!!n._webinarsArray,f=i&&r&&(!this._scheduleArray.Success||!this._webinarsArray.Success)?(new Date).getMinutes()-new Date(t).getMinutes()<5:!0;if(!(u&&i&&r&&f)){n.update(new Date);return}this._build()};n.prototype.update=function(n){var r=this,t=$.post("/MenuToLayout/MenuToLayout/ScheduleJSON?date="+new Date(n).toString("dd.MM.yyyy")),i=$.post("/MenuToLayout/MenuToLayout/WebinarJSON?date="+new Date(n).toString("dd.MM.yyyy")),u=$.Deferred(),f=$.Deferred(),e=[{ajax:t,deferred:u,lsKey:"schedule-array"},{ajax:i,deferred:f,lsKey:"webinars-array"}];e.forEach(function(t){var r=t.ajax,i=t.deferred,u=t.lsKey;r.done(function(n){y(n)?i.resolve({success:!1}):i.resolve({success:!0,response:n})}).fail(function(){i.resolve({success:!1})});i.done(function(t){var i;i=t.success?$.extend(JSON.parse(t.response),{Success:!0}):{Date:n.toString("yyyy-MM-ddT00:00:00"),Lessons:[],Success:!1};localStorage.setItem(u,JSON.stringify(i))})});$.when(t,i).done(function(){localStorage.setItem("schedule-lastrefresh",(new Date).getTime());r.load()})};n.prototype._build=function(){var n=this,t,i;n.selectDay();n.mainDivBody.empty();n.mainDivBody.css({height:"auto"});var f=this._scheduleArray.Lessons.length==0,e=this._webinarsArray.Lessons.length==0,r=this._scheduleArray.Success,u=this._webinarsArray.Success;if(r&&u){if(f&&e){n.mainDivBody.append($("<h4 />",{text:"Уроков нет :)","class":"text-center"}));return}}else if(!r&&!u){n.mainDivBody.append($("<h6 />",{text:"Не удалось загрузить расписание, повторите попытку позже","class":"text-center my-3"}));return}r?(t=[],n._scheduleArray.Lessons.forEach(function(n){t.push($.trim(n.ChangeName))}),t=v(t),n.scheduleByShifts=[],t.forEach(function(t){var r=n._scheduleArray.Lessons.filter(function(n){if($.trim(n.ChangeName)==t)return n}),i={};i.shiftName=t;i.lessons=r;n.scheduleByShifts.push(i)}),n.scheduleByShifts.forEach(function(t){var u=$("<section />"),i=$("<table />"),r;i.append(n.makeTableHeader());r=$("<tbody />");t.lessons.forEach(function(n){var t=$("<tr />"),i=$("<td />",{text:n.Number}),u=$("<td />",{text:n.StartTime+" - "+n.EndTime}),f=$("<td />").append($("<a />",{href:"/institute/journals?rooId="+n.RooId+"&instituteId="+n.InstituteId+"&departmentId="+n.DepartmentId+"&disciplineId="+n.DisciplineId+(n.GroupId?"&groupId="+n.GroupId:"")+"&periodId="+n.PeriodId,text:n.DisciplineName})),e=$("<td />").append($("<a />",{href:"/districts/"+n.RooId+"/schools/"+n.InstituteId+"/classes/"+n.DepartmentId,text:n.DepartmentName}));t.append(i).append(u).append(f).append(e);r.append(t)});i.append(r);u.append(i);u.appendTo(n.mainDivBody)})):n.mainDivBody.append($("<h6 />",{text:"Не удалось загрузить расписание, повторите попытку позже","class":"text-center my-3"}));u?n._webinarsArray.Lessons.length&&(i=$("<section />"),i.append($("<h6 />",{text:"Онлайн-уроки","class":"text-center my-3"})),i.append(this.createWebinarsTable()),n.mainDivBody.append(i)):n.mainDivBody.append($("<h6 />",{text:"Не удалось загрузить расписание онлайн-уроков, повторите попытку позже","class":"text-center my-3"}));n.mainDivBody.children("section").not(":eq(0)").before($("<hr />",{"class":"shift-separator"}))};n.prototype.makeTableHeader=function(){var n=$("<thead />"),t=$("<tr />");return t.append($("<th />",{text:"#"})).append($("<th />",{text:"Время"})).append($("<th />",{text:"Предмет"})).append($("<th />",{text:"Класс"})),n.append(t),n};n.prototype.createWebinarsTable=function(){var n=$("<table />"),i=$("<thead />").append($("<tr />").append($("<th />",{text:"Начало"})).append($("<th />",{text:"Длительность"})).append($("<th />",{text:"Предмет"})).append($("<th />",{text:"Тема"})).append($("<th />",{text:"Класс"})).append($("<th />",{text:""}))),t=$("<tbody />");return n.append(i).append(t),this._webinarsArray.Lessons.forEach(function(n){var i=$("<tr />"),r=$("<td />",{text:new Date(n.StartDate).toString("HH:mm")}),u=$("<td />",{text:n.Duration}),f=$("<td />").append($("<a />",{text:n.Discipline,href:"/institute/journals?rooId="+n.RooId+"&instituteId="+n.InstituteId+"&departmentId="+n.DepartmentId+"&periodId="+n.PeriodId})),e=$("<td />",{text:n.Theme}),o=$("<td />").append($("<a />",{text:n.DepTitle,href:"/districts/"+n.RooId+"/schools/"+n.InstituteId+"/classes/"+n.DepartmentId})),s=$("<td />").append($("<a />",{text:"Открыть урок",href:"/webinar/redirect?id="+n.Id,target:"_blank"}));i.append(r).append(u).append(f).append(e).append(o).append(s);t.append(i)}),n};n.prototype.init=function(){this.makeHeader().appendTo(this.mainDiv);this.makeBody().appendTo(this.mainDiv);this.makeFooter().appendTo(this.mainDiv)};n.prototype.makeHeader=function(){var n=this,u=["ВС","ПН","ВТ","СР","ЧТ","ПТ","СБ"],i=$("<div />",{"class":"today-journal-header"}),t,r;return n.weekDay=$("<span />"),t=$("<div />",{"class":"d-flex"}),$("<h3 />",{text:"Расписание на "}).append(n.weekDay).appendTo(t),$("<button />",{"class":"close",text:"×",on:{click:function(){$(".today-journal-button").click()}}}).appendTo(t),r=$("<div />",{"class":"weekdays-div d-flex justify-content-center"}),p(new Date).forEach(function(t){var i=$("<a />",{text:u[t.getDay()],on:{click:function(i){var r,u;i.preventDefault();r=n.mainDivBody.outerHeight();n.mainDivBody.empty();n.mainDivBody.outerHeight(r);u=$("<div />",{"class":"today-journal-body-loading text-center",css:{lineHeight:r+"px"}}).append($("<i />",{"class":"fa fa-spinner","aria-hidden":"true"})).append($("<span />",{"class":"ml-2",text:"Обновление..."}));n.mainDivBody.append(u);n.update(t)}}}).attr("model-date",t.toLocaleDateString("ru-RU"));r.append(i)}),t.appendTo(i),r.appendTo(i),i};n.prototype.selectDay=function(){var n=this,i=new Date(Date.parse(n._scheduleArray.Date)),t=new Date;$(".weekdays-div a").removeClass("selected");$(".weekdays-div a[model-date='"+i.toLocaleDateString("ru-RU")+"']").addClass("selected");$(".weekdays-div a.selected").attr("model-date")!=t.toLocaleDateString("ru-RU")?($(".weekdays-div a[model-date='"+t.toLocaleDateString("ru-RU")+"']").addClass("today"),n.weekDay.text(["воскресенье","понедельник","вторник","среду","четверг","пятницу","субботу"][i.getDay()])):($(".weekdays-div a[model-date='"+t.toLocaleDateString("ru-RU")+"']").removeClass("today"),n.weekDay.text("сегодня"))};n.prototype.makeFooter=function(){var n=this,t=$("<div />",{"class":"today-journal-footer"});return $("<a />",{href:"update-today-journal","class":"update-today-journal",text:"Обновить",on:{click:function(t){var u;t.preventDefault();var i=$(".weekdays-div a.selected").attr("model-date"),f=i.split(".")[0],e=i.split(".")[1],o=i.split(".")[2],s=new Date(Date.parse(o+"-"+e+"-"+f)),r=n.mainDivBody.outerHeight();n.mainDivBody.empty();n.mainDivBody.outerHeight(r);u=$("<div />",{"class":"today-journal-body-loading text-center",css:{lineHeight:r+"px"}}).append($("<i />",{"class":"fa fa-spinner","aria-hidden":"true"})).append($("<span />",{"class":"ml-2",text:"Обновление..."}));n.mainDivBody.append(u);setTimeout(function(){n.update(s)},200)}}}).appendTo(t),t};n.prototype.makeBody=function(){var n=this;return this.mainDivBody=$("<div />",{"class":"today-journal-body"}),this.mainDivBody};t.prototype.load=function(){var n=this;n._menuModel=JSON.parse(window.localStorage.getItem("menu-array"));n._lastRefresh=JSON.parse(window.localStorage.getItem("menu-lastrefresh"));n._userId=JSON.parse(window.localStorage.getItem("menu-userid"));n._userFio=JSON.parse(window.localStorage.getItem("menu-fio"));n._userGender=window.localStorage.getItem("menu-gender");n._unreadedMessageCount=JSON.parse(window.localStorage.getItem("unreadedmessagecount"));n._invitesCount=JSON.parse(window.localStorage.getItem("invitescount_"+i));n._userRole=JSON.parse(window.localStorage.getItem("menu-userrole"));var t=!!n._menuModel,r=Date.parse(new Date)-+n._lastRefresh<432e5,u=!!n._userId,f=n._userId==i,e=!!n._userFio,o=n._unreadedMessageCount!==null,s=n._userRole==c;if(!(t&&r&&u&&f&&e&&o&&s)){n.update(new Date);return}n._build()};t.prototype.update=function(){var n=this;waitingDialog.show();n._getFio()};t.prototype._getFio=function(){var n=this;$.ajax({type:"POST",contentType:"application/json; charset=utf-8",global:!1,url:" /MenuToLayout/MenuToLayout/UserFIOJson?UserId="+i,dataType:"json",success:function(t){window.localStorage.setItem("menu-fio",t);n._getUnreadedMessages()}})};t.prototype._getUnreadedMessages=function(){var n=this;$.ajax({type:"POST",contentType:"application/json; charset=utf-8",global:!1,url:" /MenuToLayout/MenuToLayout/UnreadedMessagesCount?UserId="+i,dataType:"json",success:function(t){window.localStorage.setItem("unreadedmessagecount",t);n._getInvitesCount()}})};t.prototype._getInvitesCount=function(){var n=this;$.ajax({type:"POST",contentType:"application/json; charset=utf-8",global:!1,url:" /MenuToLayout/MenuToLayout/UnconfirmInviteCount?UserId="+i,dataType:"json",complete:function(){n._getMenuArray()},success:function(n){window.localStorage.setItem("invitescount_"+i,n)}})};t.prototype._getMenuArray=function(){var n=this;$.ajax({type:"POST",contentType:"application/json; charset=utf-8",url:" /MenuToLayout/MenuToLayout/CreateDropdown?CurrentUserId="+i,dataType:"json",complete:function(){waitingDialog.hide()},success:function(t){var r=t,u=Date.parse(new Date);window.localStorage.setItem("menu-array",r);window.localStorage.setItem("menu-lastrefresh",u);window.localStorage.setItem("menu-userid",+i);window.localStorage.setItem("menu-userrole",+c);n.load()}})};t.prototype._build=function(){var i=this,n,t;$("nav > .new-menu > .menu-wrapper").eq(0).empty();try{$("#UserFIO").html(this._userFio.Firstname+" "+this._userFio.Surname);this.mainDiv=$("nav > .new-menu").eq(0);n=$("nav > .new-menu > .menu-wrapper");this._mainMenuList=new u(this._menuModel,n,this);this.showUnread()}catch(r){t=$("<p />",{text:"При загрузке меню произошла ошибка. ","class":"error-to-load-menu"}).append($("<a />",{text:"Загрузить ещё раз",href:"update",on:{click:function(n){n.preventDefault();window.localStorage.removeItem("menu-array");i.load()}}}));$("nav > .new-menu > .menu-wrapper").html(t)}$("nav .nav-container").css({display:"flex"})};t.prototype.showUnread=function(){var n=this;s("Messages",n._unreadedMessageCount);s("Invite",n._invitesCount)};t.prototype.toggle=function(){if(this.visible){this._hide();return}this._show()};t.prototype._show=function(){var n=this;n.visible=!0;this.mainDiv.animate({left:0},200,function(){});e&&$("html, body").css({overflow:"hidden"})};t.prototype._hide=function(){var n=this;n.visible=!1;n.mainDiv.animate({left:"-"+r},200,function(){});$("html, body").css({overflow:""})};o.prototype._draw=function(){var n=this,r=$("<li />"),u,t,i;n.link&&n.sub?(t=$("<a />",{"class":"title",href:n.link,on:{click:function(){waitingDialog.show()}}}).append($("<span />",{text:n.title})),n.parent.main&&t.attr("data-type",n.type),i=$("<a />",{"class":"next",on:{click:function(t){t.preventDefault();n.sub.show()}}}).append($("<span />")),r.append(t).append(i)):n.link&&!n.sub?(u=n.link=="Exit"?"exit":"title",t=$("<a />",{"class":u,href:n.link,on:{click:function(){waitingDialog.show()}}}).append($("<span />",{text:n.title})),n.parent.main&&t.attr("data-type",n.type),r.append(t)):!n.link&&n.sub&&(i=$("<a />",{"class":"next",on:{click:function(t){t.preventDefault();n.sub.show()}}}).append($("<span />",{text:n.title})),n.parent.main&&i.attr("data-type",n.type),r.append(i));r.find("a").eq(0).on("click",function(t){n.handler.call(this,t)});return r};u.prototype.length=function(){return this.list.length};u.prototype._draw=function(){var n=this;n.container=$("<div />",{"class":"menu-container"});n.ulHeader=$("<ul />",{"class":"menu-header",css:{display:"none"}});n.ulHeader.appendTo(n.container);n.divForScroll=$("<div />");n.divForScroll.appendTo(n.container);n.ulBody=$("<ul />",{"class":"menu-body"});n.ulBody.appendTo(n.divForScroll);n.list.forEach(function(t){t.li.appendTo(n.ulBody)});n.container.appendTo(n._place);n.main?(n._addSettings(),n.showList()):n.hideList()};u.prototype._addSettings=function(){var n=this,r=new o({EntityType:"Exit",EntityTitle:"Выйти из системы",Link:"Exit"},n._place,n,function(n){n.preventDefault();localStorage.removeItem("transferrequestscount");localStorage.removeItem("unreadedmessagecount");localStorage.removeItem("menu-userid");localStorage.removeItem("menu-userrole");localStorage.removeItem("menu-array");localStorage.removeItem("menu-lastrefresh");localStorage.removeItem("menu-fio");localStorage.removeItem("schedule-lastrefresh");localStorage.removeItem("schedule-array");localStorage.removeItem("menu-male");localStorage.removeItem("menu-gender");localStorage.removeItem("invitescount_"+i);localStorage.removeItem("webinars-array");location.href="/Logon/Logout"}),t=new o({EntityType:"Settings",EntityTitle:"Настройки меню",Sub:[{EntityTitle:"Обновить меню",Link:"Update"}]},n._place,n);t.sub.menuList.list[0].handler=function(t){t.preventDefault();waitingDialog.hide();var i=Date.parse(new Date),r=i-n.main._lastRefresh;r>6e4?n.main.update(new Date):($(this).addClass("disable-click"),setTimeout(function(){$(this).removeClass("disable-click")}.bind(this),5e3))};t.li.appendTo(n.ulBody);r.li.appendTo(n.ulBody)};u.prototype.showList=function(n){var t=this;switch(n){case"right":this.container.css({left:r});this.container.show();this.container.animate({left:"0"},100,function(){h||t.container.find('input[type="search"]').eq(0).focus()});break;case"left":this.container.css({left:"-"+r});this.container.show();this.container.animate({left:"0"},100,function(){h||t.container.find('input[type="search"]').eq(0).focus()});break;default:this.container.show()}t.makeScroll();$(window).resize(function(){t.makeScroll()})};u.prototype.hideList=function(n){var t=this;switch(n){case"right":this.container.animate({left:r},100,function(){t.container.hide()});break;case"left":this.container.animate({left:"-"+r},100,function(){t.container.hide()});break;default:this.container.hide()}this.ulBody.css({overflowY:"",height:""})};u.prototype.makeScroll=function(){this.divForScroll.height(this.container.height()-+!this.main*this.ulHeader.outerHeight());this.ulBody.height()>this.divForScroll.height()?this.divForScroll.css({overflowY:"scroll"}):this.divForScroll.css({overflowY:""})};f.prototype.makeHeader=function(){var n=this,t;n.backLi().appendTo(n.menuList.ulHeader);n.search().appendTo(n.menuList.ulHeader);t='<hr style="color: #184656; background-color: #184656; margin: 10px 20px 0;">';$(t).appendTo(n.menuList.ulHeader);n.menuList.ulHeader.show()};f.prototype.backLi=function(){var n=this,t=$("<li />"),i=$("<a />",{"class":"back",on:{click:function(){n.hide()}}}),r=$("<span />",{text:n.parentMenuList.name});return r.appendTo(i),i.appendTo(t),t};f.prototype.search=function(){var n=this,t,i;return n.menuList.length()<20?$(""):(t=$("<li />"),i=$("<input />",{type:"search",placeholder:"Поиск",on:{keyup:function(t){n._searchEngine.call(this,t,n)}}}),t.append(i),t)};f.prototype._searchEngine=function(n,t){var i=this.value,r=new RegExp(i,"i");t.menuList.list.forEach(function(n){var t=n.li.find("a.title > span").text();n.li.toggle(r.test(t))})};f.prototype.show=function(){this.parentMenuList.hideList("left");this.menuList.showList("right")};f.prototype.hide=function(){this.parentMenuList.showList("left");this.menuList.hideList("right")}})()